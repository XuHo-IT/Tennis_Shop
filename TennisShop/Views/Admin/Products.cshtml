@model IEnumerable<BussinessObject.Product>
@{
    ViewData["Title"] = "Products Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var totalProducts = Model.Count();
    var activeProducts = Model.Count(p => p.IsActive == true);
    var lowStock = Model.Count(p => (p.Stock ?? 0) < 20 && (p.Stock ?? 0) > 0);
    var outOfStock = Model.Count(p => (p.Stock ?? 0) == 0);
    var categories = Model.Where(p => !string.IsNullOrWhiteSpace(p.Category?.Name))
                          .Select(p => p.Category!.Name!)
                          .Distinct()
                          .OrderBy(c => c)
                          .ToList();
}

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-heading mb-1">Products Management</h2>
            <p class="text-muted mb-0">Manage your product inventory</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary" target="_blank">
                <i class="fas fa-external-link-alt me-2"></i>View Storefront
            </a>
            <a asp-controller="Admin" asp-action="CreateProduct" class="btn btn-dark">
                <i class="fas fa-plus me-2"></i>Add Product
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value">@totalProducts</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Active</div>
                    <div class="stat-value">@activeProducts</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Low Stock</div>
                    <div class="stat-value">@lowStock</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-danger">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Out of Stock</div>
                    <div class="stat-value">@outOfStock</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearch" class="form-control" placeholder="Search name, SKU, brand or description...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select id="categoryFilter" class="form-select">
                        <option value="all">All Categories</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat.ToLowerInvariant()">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="statusFilter" class="form-select">
                        <option value="all">Any Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="stockFilter" class="form-select">
                        <option value="all">Stock Level</option>
                        <option value="in">Healthy (≥20)</option>
                        <option value="low">Low (&lt;20)</option>
                        <option value="out">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Inventory Table</h5>
                    <small class="text-muted">Live data synced from catalog · <span id="visibleCount">@totalProducts</span> visible</small>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table modern-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width: 70px;">ID</th>
                            <th>Product</th>
                            <th>Category / Brand</th>
                            <th>Pricing</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.OrderByDescending(p => p.CreatedAt))
                        {
                            var categoryName = product.Category?.Name ?? "Uncategorized";
                            var categoryKey = categoryName.ToLowerInvariant();
                            var statusKey = product.IsActive == true ? "active" : "inactive";
                            var stockValue = product.Stock ?? 0;
                            var stockKey = stockValue == 0 ? "out" : stockValue < 20 ? "low" : "in";
                            var searchBlob = $"{product.Name} {categoryName} {product.Brand?.Name} {product.Description}".ToLower();
                            var stockBadge = stockKey == "out" ? "danger" : stockKey == "low" ? "warning" : "success";
                            
                            <tr data-product-row 
                                data-category="@categoryKey" 
                                data-status="@statusKey" 
                                data-stock="@stockKey" 
                                data-search="@searchBlob">
                                <td>
                                    <span class="id-badge">#@product.Id</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="product-image">
                                            @if (product.ProductImages?.Any() == true)
                                            {
                                                <img src="@product.ProductImages.First().ImageUrl" alt="@product.Name">
                                            }
                                            else
                                            {
                                                <div class="image-placeholder">
                                                    <i class="fas fa-image"></i>
                                                </div>
                                            }
                                        </div>
                                        <div>
                                            <div class="fw-semibold">@product.Name</div>
                                            <small class="text-muted">
                                                @(string.IsNullOrWhiteSpace(product.Description) ? "No description" :
                                                    (product.Description.Length > 60 ? product.Description.Substring(0, 60) + "..." : product.Description))
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-semibold">@categoryName</div>
                                    <small class="text-muted">@(product.Brand?.Name ?? "Unbranded")</small>
                                </td>
                                <td>
                                    <div class="fw-semibold">$@product.BasePrice.ToString("F2")</div>
                                    @if (product.DiscountPercent.HasValue && product.DiscountPercent > 0)
                                    {
                                        <small class="text-success">
                                            <i class="fas fa-tag me-1"></i>@product.DiscountPercent% off
                                        </small>
                                    }
                                </td>
                                <td>
                                    <span class="badge-tag badge-@stockBadge">@stockValue</span>
                                    <div class="text-muted small">
                                        @(stockKey == "out" ? "Need restock" : stockKey == "low" ? "Running low" : "Healthy")
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge @(statusKey == "active" ? "status-active" : "status-inactive")">
                                        @(statusKey == "active" ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" 
                                           class="btn-action btn-action-view" target="_blank" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="@Url.Action("EditProduct", "Admin", new { id = product.Id })" 
                                           class="btn-action btn-action-edit" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <form method="post" action="@Url.Action("DeleteProduct", "Admin", new { id = product.Id })" 
                                              class="d-inline" onsubmit="return confirm('Delete this product?')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn-action btn-action-delete" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="empty-state d-none">
                <i class="fas fa-box-open fa-3x mb-3"></i>
                <h5>No products found</h5>
                <p class="text-muted">Try adjusting your filters</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const stockFilter = document.getElementById('stockFilter');
    const rows = Array.from(document.querySelectorAll('[data-product-row]'));
    const emptyState = document.getElementById('emptyState');
    const visibleCount = document.getElementById('visibleCount');

    function applyFilters() {
        const query = searchInput.value.trim().toLowerCase();
        const category = categoryFilter.value;
        const status = statusFilter.value;
        const stock = stockFilter.value;
        let matches = 0;

        rows.forEach(row => {
            const matchSearch = !query || row.dataset.search.includes(query);
            const matchCategory = category === 'all' || row.dataset.category === category;
            const matchStatus = status === 'all' || row.dataset.status === status;
            const matchStock = stock === 'all' || row.dataset.stock === stock;

            const show = matchSearch && matchCategory && matchStatus && matchStock;
            row.style.display = show ? '' : 'none';
            if (show) matches++;
        });

        visibleCount.textContent = matches;
        emptyState.classList.toggle('d-none', matches > 0);
    }

    searchInput.addEventListener('input', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    stockFilter.addEventListener('change', applyFilters);

    window.clearFilters = function() {
        searchInput.value = '';
        categoryFilter.value = 'all';
        statusFilter.value = 'all';
        stockFilter.value = 'all';
        applyFilters();
    };

    applyFilters();
});
</script>
}
