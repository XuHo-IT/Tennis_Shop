@model IEnumerable<BussinessObject.Order>
@{
    ViewData["Title"] = "Orders Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var selectedStatus = ViewBag.SelectedStatus as string ?? "all";
    
    var totalOrders = Model.Count();
    var pendingOrders = Model.Count(o => o.Status?.ToLower() == "pending");
    var processingOrders = Model.Count(o => o.Status?.ToLower() == "processing");
    var shippedOrders = Model.Count(o => o.Status?.ToLower() == "shipped");
    var completedOrders = Model.Count(o => o.Status?.ToLower() == "completed");
    var totalRevenue = Model.Sum(o => o.TotalAmount ?? 0);
}

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-heading mb-1">
                <i class="fas fa-shopping-cart me-2"></i>Orders Management
            </h2>
            <p class="text-muted mb-0">Track and manage customer orders</p>
        </div>
        <button class="btn btn-dark" onclick="window.location.reload()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value">@totalOrders</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">@pendingOrders</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-info">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">In Transit</div>
                    <div class="stat-value">@(processingOrders + shippedOrders)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon bg-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@completedOrders</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="orderSearch" class="form-control" placeholder="Search by order ID, customer name or email...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2 flex-wrap justify-content-end">
                        <a href="@Url.Action("Orders", new { status = "all" })" 
                           class="btn btn-sm @(selectedStatus == "all" ? "btn-dark" : "btn-outline-secondary")">
                            <i class="fas fa-list me-1"></i>All (@totalOrders)
                        </a>
                        <a href="@Url.Action("Orders", new { status = "pending" })" 
                           class="btn btn-sm @(selectedStatus == "pending" ? "btn-warning" : "btn-outline-warning")">
                            <i class="fas fa-clock me-1"></i>Pending (@pendingOrders)
                        </a>
                        <a href="@Url.Action("Orders", new { status = "processing" })" 
                           class="btn btn-sm @(selectedStatus == "processing" ? "btn-info" : "btn-outline-info")">
                            <i class="fas fa-cog me-1"></i>Processing (@processingOrders)
                        </a>
                        <a href="@Url.Action("Orders", new { status = "shipped" })" 
                           class="btn btn-sm @(selectedStatus == "shipped" ? "btn-primary" : "btn-outline-primary")">
                            <i class="fas fa-truck me-1"></i>Shipped (@shippedOrders)
                        </a>
                        <a href="@Url.Action("Orders", new { status = "completed" })" 
                           class="btn btn-sm @(selectedStatus == "completed" ? "btn-success" : "btn-outline-success")">
                            <i class="fas fa-check me-1"></i>Completed (@completedOrders)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom" style="padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1 fw-bold">Orders List</h5>
                    <small class="text-muted">Real-time order tracking Â· <span id="visibleCount">@totalOrders</span> visible</small>
                </div>
                <div class="text-end">
                    <small class="text-muted d-block">Total Revenue</small>
                    <div class="fw-bold text-success fs-5">$@totalRevenue.ToString("N2")</div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table modern-table align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width: 100px;">ORDER ID</th>
                                <th>CUSTOMER</th>
                                <th>ORDER DATE</th>
                                <th>ITEMS</th>
                                <th>AMOUNT</th>
                                <th>PAYMENT</th>
                                <th>STATUS</th>
                                <th class="text-end">ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model.OrderByDescending(o => o.OrderDate))
                            {
                                var statusKey = order.Status?.ToLower() ?? "unknown";
                                var statusBadge = statusKey switch {
                                    "pending" => "warning",
                                    "processing" => "info",
                                    "shipped" => "primary",
                                    "completed" => "success",
                                    "cancelled" => "danger",
                                    _ => "secondary"
                                };
                                var customerName = order.User?.FullName ?? "Guest";
                                var customerEmail = order.User?.Email ?? "";
                                var searchBlob = $"#{order.Id} {customerName} {customerEmail}".ToLower();
                                var initials = string.Join("", customerName.Split(' ', StringSplitOptions.RemoveEmptyEntries).Take(2).Select(s => s[0])).ToUpper();
                                
                                <tr data-order-row data-search="@searchBlob">
                                    <td>
                                        <span class="id-badge">#@order.Id</span>
                                    </td>
                                    <td>
                                        @if (order.User != null)
                                        {
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="user-avatar" style="width: 40px; height: 40px; font-size: 0.875rem; background: linear-gradient(135deg, #6366f1, #818cf8);">
                                                    @initials
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">@order.User.FullName</div>
                                                    <small class="text-muted">@order.User.Email</small>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Guest Customer</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="fw-semibold">@order.OrderDate?.ToString("MMM dd, yyyy")</div>
                                        <small class="text-muted">@order.OrderDate?.ToString("HH:mm")</small>
                                    </td>
                                    <td>
                                        <span class="badge-tag badge-secondary">
                                            <i class="fas fa-box me-1"></i>@order.OrderItems.Count
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-bold text-success fs-6">$@order.TotalAmount?.ToString("F2")</div>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">N/A</div>
                                        <small class="text-muted">Pending</small>
                                    </td>
                                    <td>
                                        <span class="status-badge status-@statusKey text-uppercase" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                                            @order.Status
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="@Url.Action("OrderDetails", "Admin", new { id = order.Id })" 
                                               class="btn-action btn-action-view" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <div class="dropdown d-inline-block">
                                                <button class="btn-action dropdown-toggle" type="button" 
                                                        data-bs-toggle="dropdown" aria-expanded="false" title="Change Status">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end" style="min-width: 200px;">
                                                    <li>
                                                        <form method="post" action="@Url.Action("UpdateOrderStatus", "Admin")" style="margin: 0;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="orderId" value="@order.Id" />
                                                            <input type="hidden" name="status" value="pending" />
                                                            <button type="submit" class="dropdown-item @(order.Status?.ToLower() == "pending" ? "active" : "")" 
                                                                    onclick="return confirm('Change status to Pending?')">
                                                                <i class="fas fa-clock text-warning me-2"></i>Pending
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <form method="post" action="@Url.Action("UpdateOrderStatus", "Admin")" style="margin: 0;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="orderId" value="@order.Id" />
                                                            <input type="hidden" name="status" value="processing" />
                                                            <button type="submit" class="dropdown-item @(order.Status?.ToLower() == "processing" ? "active" : "")"
                                                                    onclick="return confirm('Change status to Processing?')">
                                                                <i class="fas fa-cog text-info me-2"></i>Processing
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <form method="post" action="@Url.Action("UpdateOrderStatus", "Admin")" style="margin: 0;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="orderId" value="@order.Id" />
                                                            <input type="hidden" name="status" value="shipped" />
                                                            <button type="submit" class="dropdown-item @(order.Status?.ToLower() == "shipped" ? "active" : "")"
                                                                    onclick="return confirm('Change status to Shipped?')">
                                                                <i class="fas fa-truck text-primary me-2"></i>Shipped
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <form method="post" action="@Url.Action("UpdateOrderStatus", "Admin")" style="margin: 0;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="orderId" value="@order.Id" />
                                                            <input type="hidden" name="status" value="completed" />
                                                            <button type="submit" class="dropdown-item @(order.Status?.ToLower() == "completed" ? "active" : "")"
                                                                    onclick="return confirm('Mark order as Completed?')">
                                                                <i class="fas fa-check text-success me-2"></i>Completed
                                                            </button>
                                                        </form>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form method="post" action="@Url.Action("UpdateOrderStatus", "Admin")" style="margin: 0;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="orderId" value="@order.Id" />
                                                            <input type="hidden" name="status" value="cancelled" />
                                                            <button type="submit" class="dropdown-item text-danger"
                                                                    onclick="return confirm('Are you sure you want to CANCEL this order? This action cannot be undone.')">
                                                                <i class="fas fa-times me-2"></i>Cancel Order
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <h5>No orders found</h5>
                    <p class="text-muted">Orders will appear here once customers start purchasing</p>
                </div>
            }
            <div id="emptyState" class="empty-state d-none">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>No matching orders</h5>
                <p class="text-muted">Try adjusting your search</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('orderSearch');
    const rows = Array.from(document.querySelectorAll('[data-order-row]'));
    const emptyState = document.getElementById('emptyState');
    const visibleCount = document.getElementById('visibleCount');
    const table = document.querySelector('.modern-table');

    function applySearch() {
        const query = searchInput.value.trim().toLowerCase();
        let matches = 0;

        rows.forEach(row => {
            const matchSearch = !query || row.dataset.search.includes(query);
            row.style.display = matchSearch ? '' : 'none';
            if (matchSearch) matches++;
        });

        visibleCount.textContent = matches;
        
        // Show/hide empty state and table
        if (matches === 0 && query) {
            table.style.display = 'none';
            emptyState.classList.remove('d-none');
        } else {
            table.style.display = '';
            emptyState.classList.add('d-none');
        }
    }

    searchInput.addEventListener('input', applySearch);
    applySearch();
    
    // Animate stat cards on load
    document.querySelectorAll('.stat-card').forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 * index);
    });
    
    // Add hover effect to table rows
    document.querySelectorAll('[data-order-row]').forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.01)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
});
</script>
}
